<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registrarse | OHANA</title>
    <link rel="stylesheet" type="text/css" href="resources/css/styleslogin.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        if (window.history.replaceState) {
            const cleanUrl = window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        }

        function togglePassword(inputId, buttonId) {
            const passwordInput = document.getElementById(inputId);
            const toggleBtn = document.getElementById(buttonId);

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = 'üëÅÔ∏è';
            }
        }
        window.togglePassword = togglePassword;

        document.getElementById('registroForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);

            const userData = {
                Nombre_usuario: formData.get('Nombre_usuario'),
                Apellido_usuario: formData.get('Apellido_usuario'),
                Correo: formData.get('Correo'),
                Contrasena: formData.get('Contrasena'),
                Telefono: formData.get('Telefono'),
                Direccion: formData.get('Direccion'),
                Tipo_documento: formData.get('Tipo_documento'),
                Documento_usuario: formData.get('Documento_usuario'),
                rol: formData.get('rol')
            };

            console.log('Datos a enviar desde el HTML:', userData);

            try {
                // CAMBIO IMPORTANTE: URL corregida
                const response = await fetch("registro", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(userData).toString()
                });

                console.log('Respuesta cruda del servidor:', response);

                const result = await response.json();
                console.log('JSON de respuesta del servidor:', result);

                if (response.ok &amp;&amp; result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¬°Registro Exitoso!',
                        text: result.message,
                        showConfirmButton: false,
                        timer: 3000
                    }).then(() => {
                        // CAMBIO: Redirigir a login.xhtml
                        window.location.href = 'login.xhtml';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error en el Registro',
                        text: result.error || 'Ocurri√≥ un error desconocido. Int√©ntalo de nuevo.',
                        confirmButtonColor: '#3085d6'
                    });
                }
            } catch (error) {
                console.error('Error en el fetch de registro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Conexi√≥n',
                    text: 'No se pudo conectar con el servidor. Por favor, aseg√∫rate de que el servidor Tomcat est√© en ejecuci√≥n y la URL del fetch sea correcta.',
                    confirmButtonColor: '#3085d6'
                });
            }
        });
    });
</script>
</head>
<body>
<header>
    <div class="back">
        <div class="menu container">
            <a href="OHANA.xhtml"><img src="resources/images/logo2.png" alt="logo-OHANA" class="logo-ohana" /></a>
            <input type="checkbox" id="menu" />
            <label for="menu"><img src="resources/images/menu.jpg" class="menu-icono" alt="Men√∫" /></label>
            <nav class="navbar">
                <ul>
                    <li><a href="OHANA.xhtml">Inicio</a></li>
                    <li><a href="#servicios">Nosotros</a></li>
                    <li><a href="#contacto">Contacto</a></li>
                    <li><a href="#buscar">Buscar</a></li>
                    <li><a href="login.xhtml">Inicia Sesi√≥n</a></li>
                    <li><a href="registro.xhtml" class="active">Reg√≠strate</a></li>
                </ul>
            </nav>
        </div>
    </div>
</header>

<section class="form-register">
    <h4>Crea tu cuenta y encuentra todo para el bienestar de tu mascota en un solo lugar.</h4>
    <form id="registroForm">
        <input class="controls" type="text" name="Nombre_usuario" placeholder="Ingresa tu nombre" required="required" />
        <input class="controls" type="text" name="Apellido_usuario" placeholder="Ingresa tu apellido" required="required" />
        <input class="controls" type="email" name="Correo" placeholder="Ingresa tu correo" required="required" />

        <div class="password-container">
            <input class="controls" type="password" name="Contrasena" id="password" placeholder="Crea una contrase√±a (8-16 caracteres)" required="required" minlength="8" maxlength="16" />
            <button type="button" class="toggle-password" id="togglePasswordBtn" onclick="togglePassword('password', 'togglePasswordBtn')">üëÅÔ∏è</button>
        </div>

        <input class="controls" type="tel" name="Telefono" placeholder="Ingresa tu celular" pattern="[0-9]{10}" title="Debe ser un n√∫mero de celular de 10 d√≠gitos" required="required" />
        <input class="controls" type="text" name="Direccion" placeholder="Ingresa tu direcci√≥n" required="required" />

        <select class="controls" name="Tipo_documento" required="required">
            <option value="">-- Tipo de documento --</option>
            <option value="CC">C√©dula de Ciudadan√≠a</option>
            <option value="TI">Tarjeta de Identidad</option>
            <option value="CE">C√©dula de Extranjer√≠a</option>
        </select>

        <input class="controls" type="text" name="Documento_usuario" placeholder="N√∫mero de documento" required="required" />

        <div class="form-group">
            <label for="rol" class="titulo-rol">Selecciona tu Rol:</label>
            <select class="controls" name="rol" id="rol" required="required">
                <option value="">-- Selecciona un rol --</option>
                <option value="Auxiliar">Auxiliar</option>
            </select>
        </div>

        <div class="form-group terms-checkbox">
            <input type="checkbox" id="miCheckbox" required="required" />
            <label for="miCheckbox" class="custom-checkbox">
                <span class="box"></span>
                Estoy de acuerdo con <a href="#">T√©rminos y condiciones</a>
            </label>
        </div>

        <input class="botons" type="submit" value="Registrar" />
        <p><a href="login.xhtml">¬øYa tienes una cuenta? Inicia Sesi√≥n</a></p>
    </form>
</section>
</body>
</html>